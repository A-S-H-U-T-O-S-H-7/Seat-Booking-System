<!DOCTYPE html>
<html>
<head>
    <title>CCAvenue Test Form</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .form-container { max-width: 600px; margin: 0 auto; }
        button { background: #4CAF50; color: white; padding: 15px 30px; border: none; cursor: pointer; font-size: 16px; }
        .debug { background: #f0f0f0; padding: 20px; margin: 20px 0; border-radius: 5px; }
        .debug h3 { margin-top: 0; }
    </style>
</head>
<body>
    <div class="form-container">
        <h1>CCAvenue Integration Test</h1>
        
        <div class="debug">
            <h3>Debug Information</h3>
            <p><strong>Test Order ID:</strong> TEST_<span id="timestamp"></span></p>
            <p><strong>Amount:</strong> ‚Çπ100</p>
            <p><strong>Merchant ID:</strong> 116662</p>
            <p><strong>Access Code:</strong> AVYS83MH27BT31SYTB</p>
            <p><strong>Domain:</strong> https://donate.svsamiti.com</p>
        </div>

        <button onclick="testPayment()">Create Test Payment</button>
        
        <div id="result" style="margin-top: 20px;"></div>
        
        <div class="debug" id="form-data" style="display: none;">
            <h3>Generated Form Data</h3>
            <textarea id="encrypted-data" rows="10" cols="80" readonly></textarea>
        </div>
    </div>

    <script>
        // Set timestamp
        document.getElementById('timestamp').textContent = Date.now();
        
        async function testPayment() {
            const orderId = 'TEST_' + Date.now();
            const button = document.querySelector('button');
            const result = document.getElementById('result');
            
            button.disabled = true;
            button.textContent = 'Creating Payment...';
            result.innerHTML = '<p>Creating payment request...</p>';
            
            try {
                const response = await fetch('/api/debug-ccavenue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId: orderId,
                        amount: '100',
                        billingName: 'Test User',
                        billingEmail: 'test@example.com',
                        billingTel: '9999999999',
                        billingAddress: 'Test Address',
                        isIndia: true
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    result.innerHTML = `
                        <div style="color: green;">
                            <h3>‚úÖ Payment Request Created Successfully!</h3>
                            <p><strong>Order ID:</strong> ${orderId}</p>
                            <p><strong>Encrypted Request Length:</strong> ${data.debug.encryption.encRequestLength}</p>
                            <p><strong>Access Code:</strong> ${data.testData.accessCode}</p>
                        </div>
                    `;
                    
                    // Show the actual form data
                    document.getElementById('form-data').style.display = 'block';
                    document.getElementById('encrypted-data').value = 
                        `encRequest: ${data.testData.encRequest}\n\naccess_code: ${data.testData.accessCode}`;
                    
                    // Create and submit the actual form
                    setTimeout(() => {
                        createAndSubmitForm(data.testData.encRequest, data.testData.accessCode);
                    }, 2000);
                    
                } else {
                    result.innerHTML = `
                        <div style="color: red;">
                            <h3>‚ùå Payment Request Failed</h3>
                            <p><strong>Error:</strong> ${data.error}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                result.innerHTML = `
                    <div style="color: red;">
                        <h3>‚ùå Request Failed</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
            
            button.disabled = false;
            button.textContent = 'Create Test Payment';
        }
        
        function createAndSubmitForm(encRequest, accessCode) {
            const result = document.getElementById('result');
            result.innerHTML += `
                <div style="background: #e7f3ff; padding: 15px; margin: 10px 0; border-radius: 5px;">
                    <h4>üöÄ Redirecting to CCAvenue in 3 seconds...</h4>
                    <p>If redirect doesn't work, click the button below:</p>
                    <button onclick="manualSubmit('${encRequest}', '${accessCode}')">Manual Submit to CCAvenue</button>
                </div>
            `;
            
            setTimeout(() => {
                manualSubmit(encRequest, accessCode);
            }, 3000);
        }
        
        function manualSubmit(encRequest, accessCode) {
            console.log('Creating form for CCAvenue submission...');
            console.log('encRequest length:', encRequest.length);
            console.log('accessCode:', accessCode);
            
            const form = document.createElement('form');
            form.method = 'post';
            form.action = 'https://secure.ccavenue.com/transaction/transaction.do?command=initiateTransaction';
            
            const encInput = document.createElement('input');
            encInput.type = 'hidden';
            encInput.name = 'encRequest';
            encInput.value = encRequest;
            
            const accInput = document.createElement('input');
            accInput.type = 'hidden';
            accInput.name = 'access_code';
            accInput.value = accessCode;
            
            form.appendChild(encInput);
            form.appendChild(accInput);
            document.body.appendChild(form);
            
            console.log('Submitting form to CCAvenue...');
            form.submit();
        }
    </script>
</body>
</html>
