<!DOCTYPE html>
<html>
<head>
    <title>Final CCAvenue Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 700px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .success { background: #e8f5e8; border: 1px solid #4caf50; padding: 15px; border-radius: 4px; margin: 10px 0; color: #2e7d32; }
        .error { background: #ffebee; border: 1px solid #f44336; padding: 15px; border-radius: 4px; margin: 10px 0; color: #c62828; }
        .warning { background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 4px; margin: 10px 0; color: #856404; }
        button { background: #4caf50; color: white; padding: 15px 30px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin: 10px 0; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow: auto; font-size: 12px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÜ Final CCAvenue Integration Test</h1>
        
        <div class="warning">
            <h3>üéØ Purpose</h3>
            <p>After fixing the credential mismatch (10002 error), this test will verify your CCAvenue integration works completely.</p>
        </div>

        <div class="success">
            <h3>‚úÖ What We Fixed</h3>
            <ul>
                <li><strong>10001 Error</strong> ‚Üí Fixed working key format</li>
                <li><strong>10002 Error</strong> ‚Üí Fixed mixed credential accounts</li>
                <li><strong>Form Submission</strong> ‚Üí Fixed encrypted request format</li>
                <li><strong>URL Encoding</strong> ‚Üí Fixed redirect URLs</li>
            </ul>
        </div>

        <button onclick="runFinalTest()">üöÄ Run Final Integration Test</button>
        
        <div id="test-results"></div>
        <div id="payment-form"></div>
        
        <div id="logs">
            <h3>üìã Final Test Logs:</h3>
            <pre id="log-output">Click the button to start final integration test...</pre>
        </div>
    </div>

    <script>
        let logs = [];
        
        function addLog(message) {
            const timestamp = new Date().toISOString();
            logs.push(`[${timestamp}] ${message}`);
            document.getElementById('log-output').textContent = logs.join('\n');
        }
        
        async function runFinalTest() {
            const resultsDiv = document.getElementById('test-results');
            const formDiv = document.getElementById('payment-form');
            
            addLog('Starting final integration test...');
            resultsDiv.innerHTML = '<p>Running final integration test...</p>';
            
            try {
                // Create final test payment
                const finalData = {
                    orderId: 'FINAL_' + Date.now(),
                    amount: '10.00',
                    billingName: 'Final Test User',
                    billingEmail: 'final@test.com',
                    billingTel: '9876543210',
                    billingAddress: 'Final Test Address, New Delhi',
                    isIndia: true
                };
                
                addLog(`Final test data: ${JSON.stringify(finalData, null, 2)}`);
                
                const response = await fetch('/api/ccavenue/create-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(finalData)
                });
                
                addLog(`API Response status: ${response.status}`);
                
                const data = await response.json();
                addLog(`API Response: ${JSON.stringify(data, null, 2)}`);
                
                if (data.success && data.encRequest) {
                    resultsDiv.innerHTML = `
                        <div class="success">
                            <h3>üéâ FINAL TEST SUCCESS!</h3>
                            <p><strong>Your CCAvenue integration is ready!</strong></p>
                            <ul>
                                <li>‚úÖ Credentials are properly matched</li>
                                <li>‚úÖ Encryption is working perfectly</li>
                                <li>‚úÖ Payment request created successfully</li>
                                <li>‚úÖ All APIs are functional</li>
                            </ul>
                            <p><strong>Encrypted Request Length:</strong> ${data.encRequest.length}</p>
                            <p><strong>Merchant ID:</strong> ${data.merchantId}</p>
                            <p><strong>Access Code:</strong> ${data.accessCode}</p>
                        </div>
                    `;
                    
                    // Create the final form
                    const form = document.createElement('form');
                    form.method = 'post';
                    form.action = 'https://secure.ccavenue.com/transaction/transaction.do?command=initiateTransaction';
                    form.target = '_blank';
                    
                    const encRequestInput = document.createElement('input');
                    encRequestInput.type = 'hidden';
                    encRequestInput.name = 'encRequest';
                    encRequestInput.value = data.encRequest;
                    
                    const accessCodeInput = document.createElement('input');
                    accessCodeInput.type = 'hidden';
                    accessCodeInput.name = 'access_code';
                    accessCodeInput.value = data.accessCode;
                    
                    form.appendChild(encRequestInput);
                    form.appendChild(accessCodeInput);
                    
                    formDiv.innerHTML = `
                        <div class="success">
                            <h3>üéØ Final Payment Test</h3>
                            <p><strong>This should now work perfectly!</strong></p>
                            <p>Click below to test the actual CCAvenue payment page:</p>
                            <button onclick="document.getElementById('final-form').submit()" style="background: #ff9800; padding: 20px 40px; font-size: 18px; border: none; border-radius: 4px; color: white; cursor: pointer;">
                                üöÄ TEST CCAVENUE PAYMENT PAGE
                            </button>
                            <p style="margin-top: 15px; font-size: 14px;"><strong>Expected Result:</strong> CCAvenue payment page with card input fields (no more 10001/10002 errors!)</p>
                        </div>
                    `;
                    
                    form.id = 'final-form';
                    form.style.display = 'none';
                    document.body.appendChild(form);
                    
                    addLog('SUCCESS: Final form created and ready!');
                    addLog('Expected: CCAvenue payment page should load without errors');
                    
                } else {
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <h3>‚ùå Final Test Failed</h3>
                            <p><strong>Error:</strong> ${data.error}</p>
                            <p>Please check your .env.local file and ensure all credentials are from the same CCAvenue account.</p>
                        </div>
                    `;
                    addLog(`Final test failed: ${data.error}`);
                }
                
            } catch (error) {
                addLog(`Final test error: ${error.message}`);
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Network Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
